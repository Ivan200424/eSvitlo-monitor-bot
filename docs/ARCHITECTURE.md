# üèó Architecture

–ü—Ä–æ—î–∫—Ç: eSvitlo-monitor-bot  
–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: –æ–ø–∏—Å –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ —Ç–∞ –ø—Ä–∞–≤–∏–ª –≤–∑–∞—î–º–æ–¥—ñ—ó –º—ñ–∂ —á–∞—Å—Ç–∏–Ω–∞–º–∏ —Å–∏—Å—Ç–µ–º–∏.

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –¥–∂–µ—Ä–µ–ª–æ –ø—Ä–∞–≤–¥–∏ –¥–ª—è GitHub Copilot —Ç–∞ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞.

**–û–Ω–æ–≤–ª–µ–Ω–æ:** –î–æ–¥–∞–Ω–æ —Ñ–æ—Ä–º–∞–ª—å–Ω—É State Machine —Ç–∞ Navigation Controller (–ª—é—Ç–∏–π 2026)

---

## 1. –ó–ê–ì–ê–õ–¨–ù–ê –ê–†–•–Ü–¢–ï–ö–¢–£–†–ù–ê –ú–û–î–ï–õ–¨

–ü—Ä–æ—î–∫—Ç –ø–æ–±—É–¥–æ–≤–∞–Ω–∏–π –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–æ–º —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç–µ–π:

### –û—Å–Ω–æ–≤–Ω—ñ —à–∞—Ä–∏:

1. **Handlers** ‚Äî UX —ñ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è
2. **Services** ‚Äî –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
3. **State Machine** ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å—Ç–∞–Ω–∞–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–ù–û–í–ò–ô)
4. **Navigation Controller** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞–º–∏ (–ù–û–í–ò–ô)
5. **Schedulers** ‚Äî —Ñ–æ–Ω–æ–≤—ñ –∑–∞–¥–∞—á—ñ
6. **State Manager** ‚Äî –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —Å—Ç–∞–Ω—ñ–≤
7. **Storage** ‚Äî –¥–∞–Ω—ñ (–ë–î)
8. **Formatter** ‚Äî —Ç–µ–∫—Å—Ç–∏

–ñ–æ–¥–µ–Ω —à–∞—Ä –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –ø–æ—Ä—É—à—É–≤–∞—Ç–∏ —Ü—é –º–æ–¥–µ–ª—å.

---

## 2. HANDLERS

Handlers –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –¢–Ü–õ–¨–ö–ò –∑–∞:
- –æ–±—Ä–æ–±–∫—É –∫–æ–º–∞–Ω–¥ —ñ callback
- –≤–∏–∫–ª–∏–∫ —Å–µ—Ä–≤—ñ—Å—ñ–≤
- –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è State Machine –¥–ª—è –ø–æ—Ç–æ–∫—ñ–≤
- –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Navigation Controller –¥–ª—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä
- –ø–æ–∫–∞–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É

–ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –≤ handlers:
- –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
- —Ä–æ–±–æ—Ç–∞ –∑ –±–∞–∑–æ—é –Ω–∞–ø—Ä—è–º—É
- ping IP
- scheduler logic
- —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä –Ω–∞–ø—Ä—è–º—É (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Navigation Controller)
- –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–∞–º–∏ –Ω–∞–ø—Ä—è–º—É (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ State Machine)

Handlers = thin layer.

---

## 3. SERVICES (–ë–Ü–ó–ù–ï–°-–õ–û–ì–Ü–ö–ê)

–°–µ—Ä–≤—ñ—Å–∏:
- UserService
- ChannelService
- ScheduleService
- IpMonitoringService
- AdminService
- NavigationController (–ù–û–í–ò–ô) ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é

–°–µ—Ä–≤—ñ—Å–∏:
- –ù–ï –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ Telegram API
- –ù–ï —Ñ–æ—Ä–º—É—é—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å –¥–∞–Ω—ñ –∞–±–æ —Å—Ç–∞—Ç—É—Å

–°–µ—Ä–≤—ñ—Å–∏ –º–æ–∂–Ω–∞ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –æ–∫—Ä–µ–º–æ –≤—ñ–¥ –±–æ—Ç–∞.

---

## 4. STATE MACHINE (–§–û–†–ú–ê–õ–¨–ù–ê)

**–ù–û–í–ò–ô –ö–û–ú–ü–û–ù–ï–ù–¢** ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–∞ –º–∞—à–∏–Ω–∞ —Å—Ç–∞–Ω—ñ–≤ –∑–≥—ñ–¥–Ω–æ –∑ —Ç–µ—Ö–Ω—ñ—á–Ω–æ—é —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é.

### –ü—Ä–∏–Ω—Ü–∏–ø–∏:
- **–í–°–Ü** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –ø–æ—Ç–æ–∫–∏ —è–∫ —Å–∫—ñ–Ω—á–µ–Ω–Ω–∞ –º–∞—à–∏–Ω–∞ —Å—Ç–∞–Ω—ñ–≤
- **–ñ–û–î–ù–ò–•** –Ω–µ—è–≤–Ω–∏—Ö —Å—Ç–∞–Ω—ñ–≤
- –ö–æ–∂–µ–Ω —Å—Ç–∞–Ω **–û–ë–û–í'–Ø–ó–ö–û–í–û** –º–∞—î: `onEnter`, `onInput`, `onCancel`, `onTimeout`, `onExit`
- –ö–æ–∂–µ–Ω —Å—Ç–∞–Ω **–û–ë–û–í'–Ø–ó–ö–û–í–û** –º–∞—î timeout
- Timeout **–û–ë–û–í'–Ø–ó–ö–û–í–û** –æ—á–∏—â–∞—î —Å—Ç–∞–Ω
- Cancel **–û–ë–û–í'–Ø–ó–ö–û–í–û** –ø–æ–≤–µ—Ä—Ç–∞—î –∫–æ–Ω—Ç—Ä–æ–ª—å
- –ü–µ—Ä–µ—Ö–æ–¥–∏ **–û–ë–û–í'–Ø–ó–ö–û–í–û** –ª–æ–≥—É—é—Ç—å—Å—è
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á **–ù–Ü–ö–û–õ–ò** –Ω–µ –∑–∞—Å—Ç—Ä—è—î

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
```javascript
const { StateMachine, createStateHandler } = require('./src/state/stateMachine');

const wizardMachine = new StateMachine('wizard', states, options);
await wizardMachine.start(userId, 'initialState');
await wizardMachine.handleInput(userId, input);
await wizardMachine.cancel(userId);
```

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:
–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —Ç–∞ –ø—Ä–∏–∫–ª–∞–¥–∏ —É [docs/STATE_MACHINE_NAVIGATION.md](STATE_MACHINE_NAVIGATION.md)

---

## 5. NAVIGATION CONTROLLER

**–ù–û–í–ò–ô –ö–û–ú–ü–û–ù–ï–ù–¢** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é —Ç–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞–º–∏.

### –ü—Ä–∏–Ω—Ü–∏–ø–∏:

**Reply Keyboard** (–≥–ª–æ–±–∞–ª—å–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è):
- –°—Ç–∞—Ç–∏—á–Ω–∞
- –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è –≤—Å—ñ–º –∞–∫—Ç–∏–≤–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º
- –ù–ï –∑–º—ñ–Ω—é—î —Å—Ç–∞–Ω –Ω–∞–ø—Ä—è–º—É
- –ö–Ω–æ–ø–∫–∏: üè† –ú–µ–Ω—é, üìä –ì—Ä–∞—Ñ—ñ–∫, ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, ‚ùì –î–æ–ø–æ–º–æ–≥–∞

**Inline Keyboard** (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ñ –¥—ñ—ó):
- –ü—Ä–∏–≤'—è–∑–∞–Ω—ñ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- –ú—ñ—Å—Ç—è—Ç—å –¥—ñ—ó –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- **–û–ë–û–í'–Ø–ó–ö–û–í–û** –º—ñ—Å—Ç—è—Ç—å –Ω–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –∫–Ω–æ–ø–∫–∏: ‚Üê –ù–∞–∑–∞–¥, ‚§¥ –ú–µ–Ω—é

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
```javascript
const navigationController = require('./src/services/NavigationController');

// –ì–ª–æ–±–∞–ª—å–Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
const global = navigationController.getGlobalKeyboard();

// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
const settings = navigationController.getContextualKeyboard('settings');

// Wizard –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
const wizard = navigationController.createWizardKeyboard(step, total, buttons);

// –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
const confirm = navigationController.createConfirmationKeyboard(confirmData, cancelData);

// –ü–æ–º–∏–ª–∫–∞ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ –∑ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é)
const error = navigationController.createErrorKeyboard(retryData);
```

### –ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ:
- –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ inline/reply –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –≤—Ä—É—á–Ω—É
- –ü—Ä–æ–ø—É—Å–∫–∞—Ç–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ –∫–Ω–æ–ø–∫–∏
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ reply –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è/—Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –¥—ñ–π

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:
–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —Ç–∞ –ø—Ä–∏–∫–ª–∞–¥–∏ —É [docs/STATE_MACHINE_NAVIGATION.md](STATE_MACHINE_NAVIGATION.md)

---

## 6. STATE MANAGER (–ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–Ü–°–¢–¨)

State manager:
- —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π
- –∑–±–µ—Ä—ñ–≥–∞—î —Å—Ç–∞–Ω–∏ –≤ –ø–∞–º'—è—Ç—ñ + –ë–î
- –æ–±—Ä–æ–±–ª—è—î:
  - create
  - update
  - cancel
  - timeout
  - restore after restart

**–í–ê–ñ–õ–ò–í–û:** State Manager —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î —Ä–∞–∑–æ–º –∑ State Machine:
- State Machine ‚Äî –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤ —Ç–∞ –æ–±—Ä–æ–±–∫–∞
- State Manager ‚Äî –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è

–ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ:
- —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ state –≤ –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö
- –æ–±—Ö–æ–¥–∏—Ç–∏ state manager

---

## 7. SCHEDULERS / BACKGROUND TASKS

Schedulers –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –∑–∞:
- –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
- IP-–º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
- debounce
- –ø–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ –∑–∞–¥–∞—á—ñ

–í–∏–º–æ–≥–∏:
- —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∏–π —Å—Ç–∞—Ä—Ç
- –æ–¥–∏–Ω –µ–∫–∑–µ–º–ø–ª—è—Ä
- –±–µ–∑–ø–µ—á–Ω–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç

Schedulers –ù–ï –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è –∑ handlers.

---

## 6. –ì–†–ê–§–Ü–ö–ò (DATA-FIRST)

–õ–æ–≥—ñ–∫–∞:
- –ø–∞—Ä—Å–µ—Ä ‚Üí snapshot
- snapshot ‚Üí hash
- hash ‚Üí —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é

–û–∫—Ä–µ–º–æ:
- today_snapshot
- tomorrow_snapshot

–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ñ–π –∑–º—ñ–Ω—ñ –¥–∞–Ω–∏—Ö.

---

## 7. IP-–ú–û–ù–Ü–¢–û–†–ò–ù–ì

IP engine:
- –æ–∫—Ä–µ–º–∏–π –º–æ–¥—É–ª—å
- mockable ping
- debounce
- —Å—Ç–∞–Ω–∏: ONLINE / OFFLINE / UNSTABLE / UNKNOWN

Handlers –ª–∏—à–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

---

## 8. –ê–î–ú–Ü–ù–ö–ê

–ê–¥–º—ñ–Ω-—Ñ—É–Ω–∫—Ü—ñ—ó:
- pause mode
- debounce
- —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏
- feature flags

–ê–¥–º—ñ–Ω–∫–∞:
- –ù–ï –≤–ø–ª–∏–≤–∞—î –Ω–∞–ø—Ä—è–º—É –Ω–∞ UX
- –ø—Ä–∞—Ü—é—î —á–µ—Ä–µ–∑ —Å–µ—Ä–≤—ñ—Å–∏
- –º–∞—î –ª–æ–≥—É–≤–∞–Ω–Ω—è

---

## 9. –õ–û–ì–ò –¢–ê –°–ü–û–°–¢–ï–†–ï–ñ–£–í–ê–ù–Ü–°–¢–¨

–õ–æ–≥—É–≤–∞—Ç–∏:
- –ø–æ–º–∏–ª–∫–∏
- state transitions (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ State Machine)
- navigation actions (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ Navigation Controller)
- anti-abuse
- scheduler actions

–õ–æ–≥–∏ –ø–æ–≤–∏–Ω–Ω—ñ –¥–æ–∑–≤–æ–ª—è—Ç–∏ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Å—Ü–µ–Ω–∞—Ä—ñ–π –ø–æ–¥—ñ–π.

**State Machine –ª–æ–≥—É–≤–∞–Ω–Ω—è:**
```
üîÑ [wizard] User 12345: START ‚Üí selectRegion
üîÑ [wizard] User 12345: selectRegion ‚Üí selectQueue
‚ùå [wizard] User 67890: CANCELLED from selectRegion
‚è±Ô∏è [wizard] User 11111: TIMEOUT in selectRegion
```

**Navigation Controller –ª–æ–≥—É–≤–∞–Ω–Ω—è:**
```
üß≠ [Navigation] User 12345: main ‚Üí settings (via button)
üß≠ [Navigation] User 12345: settings ‚Üí main (via back)
```

---

## 10. –ê–†–•–Ü–¢–ï–ö–¢–£–†–ù–ò–ô DoD

–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –≤–≤–∞–∂–∞—î—Ç—å—Å—è –¥–æ—Ç—Ä–∏–º–∞–Ω–æ—é, —è–∫—â–æ:
- –Ω–µ–º–∞—î –∑–º—ñ—à—É–≤–∞–Ω–Ω—è —à–∞—Ä—ñ–≤
- –∫–æ–¥ –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç–∏
- –Ω–æ–≤—ñ —Ñ—ñ—á—ñ –¥–æ–¥–∞—é—Ç—å—Å—è –±–µ–∑ —Ö–∞–æ—Å—É
- –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è State Machine –¥–ª—è –ø–æ—Ç–æ–∫—ñ–≤
- –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Navigation Controller –¥–ª—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä
- –≤—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å
- Copilot –Ω–µ –ø–æ—Ä—É—à—É—î –ø—Ä–∞–≤–∏–ª–∞

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º –¥–ª—è –∑–º—ñ–Ω.

---

**–í–µ—Ä—Å—ñ—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 2.0  
**–û—Å—Ç–∞–Ω–Ω—è –∑–º—ñ–Ω–∞:** –õ—é—Ç–∏–π 2026  
**–ê–≤—Ç–æ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** GitHub Copilot + AI Agent
